<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç‹¼ã‚²ãƒ¼ãƒ  - çµ¶æœ›ã®æª»</title>
    <style>
        :root { --bg: #0d0d0d; --accent: #9a0000; --panel: #1a1a1a; --text: #e0e0e0; }
        body { font-family: 'serif'; background: var(--bg); color: var(--text); margin: 0; padding: 10px; text-align: center; }
        h1 { font-size: 2.2rem; color: var(--accent); text-shadow: 0 0 10px #ff0000; letter-spacing: 5px; }
        .card { background: var(--panel); border: 2px solid #333; padding: 20px; border-radius: 15px; max-width: 500px; margin: 15px auto; box-shadow: 0 0 20px rgba(0,0,0,0.7); }
        button { background: var(--accent); color: white; border: none; padding: 12px 25px; cursor: pointer; border-radius: 5px; margin: 10px; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.3); }
        button:disabled { background: #333; cursor: not-allowed; opacity: 0.5; }
        input, select { padding: 10px; background: #000; color: #fff; border: 1px solid #444; width: 80%; margin: 10px; font-size: 16px; }
        .hidden { display: none; }
        .log { text-align: left; background: #000; padding: 15px; height: 140px; overflow-y: auto; border: 1px solid var(--accent); font-size: 13px; line-height: 1.5; }
        #timerDisplay { font-size: 2.5rem; color: #ff0000; font-family: 'monospace'; font-weight: bold; margin: 10px 0; }
        .setup-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; border-bottom: 1px solid #222; padding: 5px; }
        .status-msg { font-size: 14px; margin: 10px 0; min-height: 1.2em; }
    </style>
</head>
<body>

    <h1>ç‹¼ ã® æ£² ã‚€ æ‘</h1>

    <div id="setup">
        <div class="card">
            <h3>å‚åŠ è€…ã®è¨˜å¸³</h3>
            <p style="font-size:12px; color:#888;">åå‰ã‚’ã‚«ãƒ³ãƒã€Œ,ã€ã§åŒºåˆ‡ã£ã¦ãã ã•ã„</p>
            <input type="text" id="playerNames" value="A,B,C,D,E" oninput="updateCount()">
            
            <h3>å½¹ è· é­‚ é­„ ã® å‰² å½“</h3>
            <div id="roleSettings"></div>
            
            <div class="setup-row">
                <span>è­°è«–æ™‚é–“(ç§’)</span>
                <input type="number" id="talkTime" value="180" style="width: 70px;">
            </div>
            
            <div id="countCheck" class="status-msg"></div>
            <button id="startBtn" onclick="startGame()">æƒ¨åŠ‡ã®å¹•ã‚’é–‹ã‘ã‚‹</button>
        </div>
    </div>

    <div id="game" class="hidden">
        <h2 id="phaseTitle"></h2>
        <div id="displayArea" class="card">
            <div id="timerArea" class="hidden"><p>è­°è«–çµ‚äº†ã¾ã§</p><div id="timerDisplay"></div></div>
            <p id="infoText"></p>
            <div id="actionArea"></div>
        </div>
        <button id="mainBtn">é€²ã‚€</button>
    </div>

    <div id="logArea" class="hidden" style="max-width:500px; margin:auto;">
        <p style="text-align:left; color:var(--accent); font-weight:bold;">ã€ æ‘ã®è¨˜æ†¶ ã€‘</p>
        <div id="log" class="log"></div>
    </div>

<script>
    let players = [];
    let currentPlayerIndex = 0;
    // ã€Œå¸‚æ°‘ã€ã‚’æ˜ç¤ºçš„ã«ãƒªã‚¹ãƒˆã®æœ€åˆã«è¿½åŠ 
    let rolesConfig = { 'å¸‚æ°‘': 2, 'äººç‹¼': 1, 'å ã„å¸«': 1, 'é¨å£«': 0, 'éœŠåª’å¸«': 0, 'æ€ªç›—': 1, 'ç‹‚äºº': 0 };
    let yesterdayExiled = null;
    let votes = {};
    let isInitialNight = true;
    let timerInterval;
    let actionExecuted = false;

    const roleDetails = {
        'å¸‚æ°‘': 'èƒ½åŠ›ã¯ç„¡ã„ã€‚çŸ¥æµã‚’çµã‚Šã€ç‹¼ã‚’æš´ã‘ã€‚', 
        'äººç‹¼': 'å¤œã«äººã‚’è¥²æ’ƒã™ã‚‹ã€‚ä»²é–“ã®ç‹¼ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚', 
        'å ã„å¸«': 'æ¯æ™©ã€èª°ã‹ä¸€äººã®æ­£ä½“ã‚’è¦–ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚',
        'é¨å£«': 'æ¯æ™©ã€ä¸€äººã‚’ç‹¼ã‹ã‚‰å®ˆã‚‹ã€‚è‡ªåˆ†ã¯å®ˆã‚Œãªã„ã€‚', 
        'éœŠåª’å¸«': 'å¤œã«ã€ãã®æ—¥è¿½æ”¾ã•ã‚ŒãŸè€…ã®æ­£ä½“ã‚’çŸ¥ã‚‹ã€‚', 
        'ç‹‚äºº': 'äººç‹¼ã®å‘³æ–¹ã€‚äººé–“ã¨ã—ã¦å ã‚ã‚Œã‚‹ã€‚',
        'æ€ªç›—': 'æœ€åˆã®å¤œã«ã€èª°ã‹ã®å½¹è·ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚'
    };

    function initSetup() {
        const container = document.getElementById('roleSettings');
        container.innerHTML = "";
        Object.keys(rolesConfig).forEach(role => {
            container.innerHTML += `<div class="setup-row"><span>${role}</span><div>
                <button onclick="changeRole('${role}', -1)">-</button>
                <span id="label_${role}" style="display:inline-block; width:20px;">${rolesConfig[role]}</span>
                <button onclick="changeRole('${role}', 1)">+</button>
            </div></div>`;
        });
        updateCount();
    }

    function changeRole(r, v) { 
        rolesConfig[r] = Math.max(0, rolesConfig[r] + v); 
        document.getElementById(`label_${r}`).innerText = rolesConfig[r]; 
        updateCount(); 
    }

    function updateCount() {
        const names = document.getElementById('playerNames').value.split(',').map(n => n.trim()).filter(n => n !== "");
        const playerCount = names.length;
        const roleSum = Object.values(rolesConfig).reduce((a, b) => a + b, 0);
        const diff = playerCount - roleSum;
        
        const countCheck = document.getElementById('countCheck');
        const startBtn = document.getElementById('startBtn');

        if (playerCount < 3) {
            countCheck.innerHTML = `<span style="color:#ff4b2b;">å°‘ãªãã¨ã‚‚3äººã®åå‰ãŒå¿…è¦ã§ã™</span>`;
            startBtn.disabled = true;
        } else if (diff > 0) {
            countCheck.innerHTML = `<span style="color:#ff9f43;">ã‚ã¨ ${diff} äººåˆ†ã®å½¹è·ãŒæœªè¨­å®šã§ã™</span>`;
            startBtn.disabled = true;
        } else if (diff < 0) {
            countCheck.innerHTML = `<span style="color:#ff4b2b;">å½¹è·ãŒ ${Math.abs(diff)} äººåˆ†å¤šã™ãã¾ã™</span>`;
            startBtn.disabled = true;
        } else {
            countCheck.innerHTML = `<span style="color:#4ecca3;">æº–å‚™å®Œäº†ï¼ˆ${playerCount}åï¼‰</span>`;
            startBtn.disabled = false;
        }
    }

    function startGame() {
        const names = document.getElementById('playerNames').value.split(',').map(n => n.trim()).filter(n => n !== "");
        let rolePool = [];
        Object.keys(rolesConfig).forEach(r => { 
            for(let i=0; i<rolesConfig[r]; i++) rolePool.push(r); 
        });
        
        rolePool.sort(() => Math.random() - 0.5);
        players = names.map((name, i) => ({ name, role: rolePool[i], isAlive: true, target: null }));
        
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        document.getElementById('logArea').classList.remove('hidden');
        startConfirm();
    }

    // --- ä»¥é™ã®ã‚²ãƒ¼ãƒ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã¯Ver.5.1ã‚’ç¶™æ‰¿ ---

    function startConfirm() { currentPlayerIndex = 0; showConfirm(); }
    function showConfirm() {
        document.getElementById('phaseTitle').innerText = "â—† å½¹è·ç¢ºèª â—†";
        if (currentPlayerIndex < players.length) {
            document.getElementById('infoText').innerText = `${players[currentPlayerIndex].name}ã•ã‚“ä»¥å¤–ã¯è¦‹ãªã„ã§ãã ã•ã„ã€‚`;
            document.getElementById('actionArea').innerHTML = "";
            document.getElementById('mainBtn').onclick = () => {
                document.getElementById('infoText').innerText = `æ±ã¯ã€${players[currentPlayerIndex].role}ã€‘ãªã‚Šã€‚\n${roleDetails[players[currentPlayerIndex].role]}`;
                document.getElementById('mainBtn').onclick = () => { currentPlayerIndex++; showConfirm(); };
            };
        } else { startNight(); }
    }

    function startNight() {
        document.getElementById('phaseTitle').innerText = "ğŸŒ™ å¤œã®è¡Œå‹•";
        currentPlayerIndex = 0;
        processNight();
    }

    function processNight() {
        let activeRoles = isInitialNight ? ['æ€ªç›—', 'å ã„å¸«'] : ['äººç‹¼', 'å ã„å¸«', 'é¨å£«', 'éœŠåª’å¸«'];
        showNightAction(activeRoles);
    }

    function showNightAction(activeRoles) {
        const currentRole = activeRoles[currentPlayerIndex];
        if (!currentRole) { 
            if (isInitialNight) { isInitialNight = false; startTalk(); } 
            else { resolveNight(); }
            return; 
        }

        const actor = players.find(p => p.role === currentRole && p.isAlive);
        if (!actor) { currentPlayerIndex++; showNightAction(activeRoles); return; }

        document.getElementById('infoText').innerText = `${currentRole}ã®è¦šé†’ã€‚\n${actor.name}ã•ã‚“ä»¥å¤–ã¯è¦‹ãªã„ã§ãã ã•ã„ã€‚`;
        document.getElementById('actionArea').innerHTML = "";
        document.getElementById('mainBtn').onclick = () => {
            actionExecuted = false;
            let html = `<select id="target">`;
            let targets = players.filter(p => p.isAlive && p.name !== actor.name);
            html += targets.map(p => `<option value="${p.name}">${p.name}</option>`).join('') + `</select>`;
            html += `<button id="doBtn">ç§˜è¡“å®Ÿè¡Œ</button><p id="res" style="color:#4ecca3; font-weight:bold;"></p>`;
            document.getElementById('actionArea').innerHTML = html;

            document.getElementById('doBtn').onclick = () => {
                if(actionExecuted) return;
                const target = players.find(p => p.name === document.getElementById('target').value);
                if (currentRole === 'å ã„å¸«') {
                    document.getElementById('res').innerText = `${target.name}ã¯ã€${target.role === 'äººç‹¼' ? 'äººç‹¼' : 'äººé–“'}ã€‘ãªã‚Šã€‚`;
                } else if (currentRole === 'æ€ªç›—') {
                    const stolenRole = target.role;
                    target.role = 'å¸‚æ°‘'; // å¥ªã‚ã‚ŒãŸäººã¯å¸‚æ°‘ã«ãªã‚‹
                    actor.role = stolenRole;
                    document.getElementById('res').innerText = `${target.name}ã‚ˆã‚Šã€${stolenRole}ã€‘ã‚’å¥ªå–ã—ãŸï¼`;
                } else if (currentRole === 'éœŠåª’å¸«') {
                    document.getElementById('res').innerText = yesterdayExiled ? `${yesterdayExiled.name}ã¯ã€${yesterdayExiled.role === 'äººç‹¼' ? 'äººç‹¼' : 'äººé–“'}ã€‘ã§ã‚ã£ãŸã€‚` : "è¿½æ”¾è€…ãªã—";
                } else if (currentRole === 'äººç‹¼' || currentRole === 'é¨å£«') {
                    actor.target = target.name;
                    document.getElementById('res').innerText = "æ¨™çš„ã‚’å®šã‚ãŸã€‚";
                }
                actionExecuted = true;
                document.getElementById('doBtn').disabled = true;
            };
            document.getElementById('mainBtn').onclick = () => { currentPlayerIndex++; showNightAction(activeRoles); };
        };
    }

    function startTalk() {
        document.getElementById('phaseTitle').innerText = "â˜€ï¸ è­°è«–ã®åˆ»";
        document.getElementById('timerArea').classList.remove('hidden');
        document.getElementById('infoText').innerText = "è¨€è‘‰ã®åˆƒã§ç‹¼ã‚’è¿½ã„è©°ã‚ã‚ˆã€‚";
        document.getElementById('actionArea').innerHTML = "";
        let time = document.getElementById('talkTime').value;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            document.getElementById('timerDisplay').innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
            if (time-- <= 0) { clearInterval(timerInterval); alert("è­°è«–çµ‚äº†ï¼"); startIndividualVote(); }
        }, 1000);
        document.getElementById('mainBtn').innerText = "æŠ•ç¥¨ã¸ç§»ã‚‹";
        document.getElementById('mainBtn').onclick = () => { clearInterval(timerInterval); startIndividualVote(); };
    }

    function startIndividualVote() {
        document.getElementById('timerArea').classList.add('hidden');
        document.getElementById('phaseTitle').innerText = "âš–ï¸ ç§˜å¯†ã®æŠ•ç¥¨";
        currentPlayerIndex = 0; votes = {};
        showNextVote();
    }

    function showNextVote() {
        const alives = players.filter(p=>p.isAlive);
        if (currentPlayerIndex < alives.length) {
            const voter = alives[currentPlayerIndex];
            document.getElementById('infoText').innerText = `${voter.name}æ®¿ã®æŠ•ç¥¨ã€‚`;
            document.getElementById('actionArea').innerHTML = `<select id="vSelect">` + 
                alives.filter(p=>p.name !== voter.name).map(p=>`<option value="${p.name}">${p.name}</option>`).join('') + `</select>`;
            document.getElementById('mainBtn').innerText = "æŠ•ã˜ã‚‹";
            document.getElementById('mainBtn').onclick = () => {
                const val = document.getElementById('vSelect').value;
                votes[val] = (votes[val] || 0) + 1;
                currentPlayerIndex++; showNextVote();
            };
        } else { tallyVote(); }
    }

    function tallyVote() {
        let max = 0; let exiled = null;
        for (let name in votes) { if (votes[name] > max) { max = votes[name]; exiled = name; } }
        const p = players.find(p => p.name === exiled);
        p.isAlive = false; yesterdayExiled = p;
        addLog(`ã€å‡¦åˆ‘ã€‘æŠ•ç¥¨ã®çµæœã€${exiled}æ®¿ãŒæ‘ã‚’å»ã£ãŸã€‚`);
        if (!checkWin()) startNight();
    }

    function resolveNight() {
        const wolf = players.find(p => p.role === 'äººç‹¼' && p.isAlive);
        const knight = players.find(p => p.role === 'é¨å£«' && p.isAlive);
        let killed = null;
        if (wolf && wolf.target && wolf.target !== (knight ? knight.target : null)) {
            const p = players.find(p => p.name === wolf.target);
            p.isAlive = false; killed = p.name;
            addLog(`ã€è¥²æ’ƒã€‘æ˜¨æ™©ã€${killed}æ®¿ãŒçŠ ç‰²ã¨ãªã£ãŸã€‚`);
        } else { addLog("ã€å®ˆè­·ã€‘é¨å£«ã®åŠ è­·ã«ã‚ˆã‚Šã€çŠ ç‰²è€…ã¯å‡ºãªã‹ã£ãŸã€‚"); }
        players.forEach(p => p.target = null);
        if (!checkWin()) startTalk();
    }

    function checkWin() {
        const wolves = players.filter(p => p.isAlive && p.role === 'äººç‹¼').length;
        const humans = players.filter(p => p.isAlive && (p.role !== 'äººç‹¼' && p.role !== 'ç‹‚äºº')).length;
        if (wolves === 0) { alert("äººç‹¼ã¯æ»…ã³ãŸï¼æ‘äººå´ã®å‹åˆ©ï¼"); location.reload(); return true; }
        if (wolves >= humans) { alert("æ‘ã¯ç‹¼ã«æ”¯é…ã•ã‚ŒãŸâ€¦äººç‹¼å´ã®å‹åˆ©ï¼"); location.reload(); return true; }
        return false;
    }

    function addLog(m) { const l = document.getElementById('log'); l.innerHTML = `<div style="border-bottom:1px solid #222; margin-bottom:5px;">${m}</div>` + l.innerHTML; }

    initSetup();
</script>
</body>
</html>
