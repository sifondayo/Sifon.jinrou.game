<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>äººç‹¼ã‚²ãƒ¼ãƒ  - çµ¶æœ›ã®æª» Ver.6.0</title>
    <style>
        :root { --bg: #0d0d0d; --accent: #9a0000; --panel: #1a1a1a; --text: #e0e0e0; --fox: #f1c40f; --teru: #ecf0f1; --bread: #e67e22; }
        body { font-family: 'serif'; background: var(--bg); color: var(--text); margin: 0; padding: 10px; text-align: center; overflow-x: hidden; }
        h1 { font-size: 2rem; color: var(--accent); text-shadow: 0 0 10px #ff0000; letter-spacing: 3px; }
        .card { background: var(--panel); border: 2px solid #333; padding: 20px; border-radius: 15px; max-width: 500px; margin: 15px auto; box-shadow: 0 0 20px rgba(0,0,0,0.7); position: relative; }
        button { background: var(--accent); color: white; border: none; padding: 12px 25px; cursor: pointer; border-radius: 5px; margin: 10px; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.3); }
        button:disabled { background: #333; cursor: not-allowed; opacity: 0.5; }
        input, select { padding: 10px; background: #000; color: #fff; border: 1px solid #444; width: 85%; margin: 10px; font-size: 16px; border-radius: 5px; }
        .hidden { display: none; }
        .log { text-align: left; background: #000; padding: 15px; height: 160px; overflow-y: auto; border: 1px solid var(--accent); font-size: 13px; line-height: 1.6; border-radius: 5px; }
        #timerDisplay { font-size: 2.8rem; color: #ff0000; font-family: 'monospace'; font-weight: bold; margin: 10px 0; }
        .setup-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; border-bottom: 1px solid #222; padding: 5px; }
        .role-help-btn { background: #333; color: #bbb; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px; cursor: help; }
        .status-msg { font-size: 14px; margin: 10px 0; min-height: 1.2em; font-weight: bold; }
        .role-info { font-size: 0.9rem; color: #aaa; margin-top: 5px; font-style: italic; }
    </style>
</head>
<body>

    <h1>ç‹¼ ã® æ£² ã‚€ æ‘ <span style="font-size: 0.8rem; vertical-align: middle; opacity: 0.6;">Ver.6.0</span></h1>

    <div id="setup">
        <div class="card">
            <h3>å‚åŠ è€…ã®è¨˜å¸³</h3>
            <input type="text" id="playerNames" value="A,B,C,D,E,F" oninput="updateCount()" placeholder="åå‰ã‚’ã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‹">
            
            <h3>å½¹è·ã®æ§‹æˆ</h3>
            <p style="font-size:11px; color:#888;">å½¹è·åã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            <div id="roleSettings"></div>
            
            <div class="setup-row">
                <span>è­°è«–æ™‚é–“(ç§’)</span>
                <input type="number" id="talkTime" value="180" style="width: 70px;">
            </div>
            
            <div id="countCheck" class="status-msg"></div>
            <button id="startBtn" onclick="startGame()">æƒ¨åŠ‡ã®å¹•ã‚’é–‹ã‘ã‚‹</button>
        </div>
    </div>

    <div id="game" class="hidden">
        <h2 id="phaseTitle"></h2>
        <div id="displayArea" class="card">
            <div id="timerArea" class="hidden"><p>è­°è«–çµ‚äº†ã¾ã§</p><div id="timerDisplay"></div></div>
            <p id="infoText" style="white-space: pre-wrap;"></p>
            <div id="actionArea"></div>
        </div>
        <button id="mainBtn">é€²ã‚€</button>
    </div>

    <div id="logArea" class="hidden" style="max-width:500px; margin:auto;">
        <p style="text-align:left; color:var(--accent); font-weight:bold; font-size:14px;">ã€ æ‘ã®è¨˜æ†¶ ã€‘</p>
        <div id="log" class="log"></div>
    </div>

<script>
    let players = [];
    let currentPlayerIndex = 0;
    let rolesConfig = { 'å¸‚æ°‘': 2, 'äººç‹¼': 1, 'å ã„å¸«': 1, 'é¨å£«': 0, 'éœŠåª’å¸«': 0, 'æ€ªç›—': 1, 'ç‹‚äºº': 0, 'ãƒ‘ãƒ³å±‹': 0, 'ç‹': 0, 'ã¦ã‚‹ã¦ã‚‹': 0, 'ç‹‚ä¿¡è€…': 0 };
    let yesterdayExiled = null;
    let votes = {};
    let isInitialNight = true;
    let timerInterval;
    let actionExecuted = false;

    const roleDetails = {
        'å¸‚æ°‘': 'èƒ½åŠ›ã¯ç„¡ã„ã€‚çŸ¥æµã‚’çµã‚Šã€ç‹¼ã‚’æš´ã‘ã€‚', 
        'äººç‹¼': 'å¤œã«äººã‚’è¥²æ’ƒã™ã‚‹ã€‚ä»²é–“ã®ç‹¼ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚', 
        'å ã„å¸«': 'æ¯æ™©ã€èª°ã‹ä¸€äººã®æ­£ä½“ã‚’è¦–ã‚‹ã€‚ç‹ã‚’å ã†ã¨å‘ªæ®ºã§ãã‚‹ã€‚',
        'é¨å£«': 'æ¯æ™©ã€ä¸€äººã‚’ç‹¼ã‹ã‚‰å®ˆã‚‹ã€‚è‡ªåˆ†ã¯å®ˆã‚Œãªã„ã€‚', 
        'éœŠåª’å¸«': 'å¤œã«ã€ãã®æ—¥è¿½æ”¾ã•ã‚ŒãŸè€…ã®æ­£ä½“ï¼ˆç‹¼ã‹äººé–“ã‹ï¼‰ã‚’çŸ¥ã‚‹ã€‚', 
        'æ€ªç›—': 'æœ€åˆã®å¤œã«ã€èª°ã‹ã®å½¹è·ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚',
        'ç‹‚äºº': 'äººç‹¼ã®å‘³æ–¹ã€‚å ã‚ã‚Œã¦ã‚‚äººé–“ã¨å‡ºã‚‹ã€‚',
        'ãƒ‘ãƒ³å±‹': 'ç”Ÿãã¦ã„ã‚‹é™ã‚Šã€æ¯æœæ‘ã«ãƒ‘ãƒ³ã‚’å±Šã‘ã‚‹ã€‚ç”Ÿå­˜ç¢ºèªã®è¦ã€‚',
        'ç‹': 'ç‹¼ã«è¥²ã‚ã‚Œã¦ã‚‚æ­»ãªãªã„ãŒã€å ã‚ã‚Œã‚‹ã¨æ­»ã¬ã€‚æœ€å¾Œã¾ã§æ®‹ã‚Œã°å˜ç‹¬å‹åˆ©ã€‚',
        'ã¦ã‚‹ã¦ã‚‹': 'è¿½æ”¾ã•ã‚ŒãŸã‚‰å‹åˆ©ã€‚ãã‚Œä»¥å¤–ã«ç›®çš„ã¯ãªã„ã€‚',
        'ç‹‚ä¿¡è€…': 'äººç‹¼ã®å‘³æ–¹ã€‚æœ€åˆã‹ã‚‰èª°ãŒäººç‹¼ã‹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚'
    };

    function initSetup() {
        const container = document.getElementById('roleSettings');
        container.innerHTML = "";
        Object.keys(rolesConfig).forEach(role => {
            container.innerHTML += `<div class="setup-row">
                <span onclick="alert('${role}: ${roleDetails[role]}')" style="cursor:pointer; border-bottom:1px dotted #555;">${role} â“˜</span>
                <div>
                    <button onclick="changeRole('${role}', -1)">-</button>
                    <span id="label_${role}" style="display:inline-block; width:20px; font-weight:bold;">${rolesConfig[role]}</span>
                    <button onclick="changeRole('${role}', 1)">+</button>
                </div>
            </div>`;
        });
        updateCount();
    }

    function changeRole(r, v) { 
        rolesConfig[r] = Math.max(0, rolesConfig[r] + v); 
        document.getElementById(`label_${r}`).innerText = rolesConfig[r]; 
        updateCount(); 
    }

    function updateCount() {
        const names = document.getElementById('playerNames').value.split(',').map(n => n.trim()).filter(n => n !== "");
        const playerCount = names.length;
        const roleSum = Object.values(rolesConfig).reduce((a, b) => a + b, 0);
        const diff = playerCount - roleSum;
        const countCheck = document.getElementById('countCheck');
        const startBtn = document.getElementById('startBtn');

        if (playerCount < 3) {
            countCheck.innerHTML = `<span style="color:#ff4b2b;">å°‘ãªãã¨ã‚‚3äººã®åå‰ãŒå¿…è¦ã§ã™</span>`;
            startBtn.disabled = true;
        } else if (diff !== 0) {
            countCheck.innerHTML = `<span style="color:#ff9f43;">äººæ•°ã¨å½¹è·ã‚’ä¸€è‡´ã•ã›ã¦ãã ã•ã„ï¼ˆå·®: ${diff > 0 ? '+'+diff : diff}ï¼‰</span>`;
            startBtn.disabled = true;
        } else {
            countCheck.innerHTML = `<span style="color:#4ecca3;">æº–å‚™å®Œäº†ï¼ˆ${playerCount}åï¼‰</span>`;
            startBtn.disabled = false;
        }
    }

    function startGame() {
        const names = document.getElementById('playerNames').value.split(',').map(n => n.trim()).filter(n => n !== "");
        let rolePool = [];
        Object.keys(rolesConfig).forEach(r => { for(let i=0; i<rolesConfig[r]; i++) rolePool.push(r); });
        rolePool.sort(() => Math.random() - 0.5);
        players = names.map((name, i) => ({ name, role: rolePool[i], isAlive: true, target: null }));
        
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        document.getElementById('logArea').classList.remove('hidden');
        startConfirm();
    }

    function startConfirm() { currentPlayerIndex = 0; showConfirm(); }
    function showConfirm() {
        document.getElementById('phaseTitle').innerText = "â—† å½¹è·ç¢ºèª â—†";
        if (currentPlayerIndex < players.length) {
            const p = players[currentPlayerIndex];
            document.getElementById('infoText').innerText = `${p.name}ã•ã‚“ä»¥å¤–ã¯è¦‹ãªã„ã§ãã ã•ã„ã€‚`;
            document.getElementById('actionArea').innerHTML = "";
            document.getElementById('mainBtn').onclick = () => {
                let extra = "";
                if(p.role === 'ç‹‚ä¿¡è€…' || p.role === 'äººç‹¼') {
                    const wolves = players.filter(pl => pl.role === 'äººç‹¼').map(pl => pl.name).join(', ');
                    extra = `\n\nã€äººç‹¼ä»²é–“ã€‘: ${wolves}`;
                }
                document.getElementById('infoText').innerText = `æ±ã¯ã€${p.role}ã€‘ãªã‚Šã€‚\n${roleDetails[p.role]}${extra}`;
                document.getElementById('mainBtn').onclick = () => { currentPlayerIndex++; showConfirm(); };
            };
        } else { startNight(); }
    }

    function startNight() {
        document.getElementById('phaseTitle').innerText = "ğŸŒ™ å¤œã®è¡Œå‹•";
        currentPlayerIndex = 0;
        processNight();
    }

    function processNight() {
        let activeRoles = isInitialNight ? ['æ€ªç›—', 'å ã„å¸«'] : ['äººç‹¼', 'å ã„å¸«', 'é¨å£«', 'éœŠåª’å¸«'];
        showNightAction(activeRoles);
    }

    function showNightAction(activeRoles) {
        const currentRole = activeRoles[currentPlayerIndex];
        if (!currentRole) { 
            if (isInitialNight) { isInitialNight = false; startTalk(); } 
            else { resolveNight(); }
            return; 
        }
        const actor = players.find(p => p.role === currentRole && p.isAlive);
        if (!actor) { currentPlayerIndex++; showNightAction(activeRoles); return; }

        document.getElementById('infoText').innerText = `${currentRole}ã®è¦šé†’ã€‚\n${actor.name}ã•ã‚“ä»¥å¤–ã¯è¦‹ãªã„ã§ãã ã•ã„ã€‚`;
        document.getElementById('actionArea').innerHTML = "";
        document.getElementById('mainBtn').onclick = () => {
            actionExecuted = false;
            let targets = players.filter(p => p.isAlive && p.name !== actor.name);
            let html = `<select id="target">` + targets.map(p => `<option value="${p.name}">${p.name}</option>`).join('') + `</select>`;
            html += `<button id="doBtn">ç§˜è¡“å®Ÿè¡Œ</button><p id="res" style="color:#f1c40f; font-weight:bold;"></p>`;
            document.getElementById('actionArea').innerHTML = html;

            document.getElementById('doBtn').onclick = () => {
                if(actionExecuted) return;
                const target = players.find(p => p.name === document.getElementById('target').value);
                if (currentRole === 'å ã„å¸«') {
                    let result = (target.role === 'äººç‹¼') ? 'äººç‹¼' : 'äººé–“';
                    if (target.role === 'ç‹') { target.isAlive = false; target.killedBy = 'å æ®º'; }
                    document.getElementById('res').innerText = `${target.name}ã¯ã€${result}ã€‘ãªã‚Šã€‚`;
                } else if (currentRole === 'æ€ªç›—') {
                    const stolen = target.role; target.role = 'å¸‚æ°‘'; actor.role = stolen;
                    document.getElementById('res').innerText = `${target.name}ã‹ã‚‰ã€${stolen}ã€‘ã‚’ç›—ã‚“ã ï¼`;
                } else if (currentRole === 'éœŠåª’å¸«') {
                    document.getElementById('res').innerText = yesterdayExiled ? `${yesterdayExiled.name}ã¯ã€${yesterdayExiled.role === 'äººç‹¼' ? 'äººç‹¼' : 'äººé–“'}ã€‘ã§ã‚ã£ãŸã€‚` : "è¿½æ”¾è€…ãªã—";
                } else {
                    actor.target = target.name;
                    document.getElementById('res').innerText = "æ¨™çš„ã‚’å®šã‚ãŸã€‚";
                }
                actionExecuted = true; document.getElementById('doBtn').disabled = true;
            };
            document.getElementById('mainBtn').onclick = () => { currentPlayerIndex++; showNightAction(activeRoles); };
        };
    }

    function startTalk() {
        document.getElementById('phaseTitle').innerText = "â˜€ï¸ è­°è«–ã®åˆ»";
        document.getElementById('timerArea').classList.remove('hidden');
        document.getElementById('infoText').innerText = "è¨€è‘‰ã®åˆƒã§ç‹¼ã‚’è¿½ã„è©°ã‚ã‚ˆã€‚";
        document.getElementById('actionArea').innerHTML = "";
        
        // ãƒ‘ãƒ³å±‹ã®ç”Ÿå­˜ç¢ºèª
        if (players.some(p => p.role === 'ãƒ‘ãƒ³å±‹' && p.isAlive)) {
            addLog(`<span style="color:var(--bread)">ã€ãƒ‘ãƒ³å±‹ã€‘ã»ã‹ã»ã‹ã®ãƒ‘ãƒ³ãŒç„¼ã‘ã¾ã—ãŸã€‚ä»Šæ—¥ã‚‚ãƒ‘ãƒ³å±‹ã¯å…ƒæ°—ã§ã™ã€‚</span>`);
        }

        let time = document.getElementById('talkTime').value;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            document.getElementById('timerDisplay').innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
            if (time-- <= 0) { clearInterval(timerInterval); alert("è­°è«–çµ‚äº†ï¼"); startIndividualVote(); }
        }, 1000);
        document.getElementById('mainBtn').innerText = "æŠ•ç¥¨ã¸ç§»ã‚‹";
        document.getElementById('mainBtn').onclick = () => { clearInterval(timerInterval); startIndividualVote(); };
    }

    function startIndividualVote() {
        document.getElementById('timerArea').classList.add('hidden');
        document.getElementById('phaseTitle').innerText = "âš–ï¸ ç§˜å¯†ã®æŠ•ç¥¨";
        currentPlayerIndex = 0; votes = {};
        showNextVote();
    }

    function showNextVote() {
        const alives = players.filter(p=>p.isAlive);
        if (currentPlayerIndex < alives.length) {
            const voter = alives[currentPlayerIndex];
            document.getElementById('infoText').innerText = `${voter.name}æ®¿ã®æŠ•ç¥¨ã€‚`;
            document.getElementById('actionArea').innerHTML = `<select id="vSelect">` + alives.filter(p=>p.name !== voter.name).map(p=>`<option value="${p.name}">${p.name}</option>`).join('') + `</select>`;
            document.getElementById('mainBtn').innerText = "æŠ•ã˜ã‚‹";
            document.getElementById('mainBtn').onclick = () => {
                const val = document.getElementById('vSelect').value;
                votes[val] = (votes[val] || 0) + 1;
                currentPlayerIndex++; showNextVote();
            };
        } else { tallyVote(); }
    }

    function tallyVote() {
        let max = 0; let exiled = null;
        for (let name in votes) { if (votes[name] > max) { max = votes[name]; exiled = name; } }
        const p = players.find(p => p.name === exiled);
        p.isAlive = false; yesterdayExiled = p;
        addLog(`ã€å‡¦åˆ‘ã€‘${exiled}æ®¿ãŒè¿½æ”¾ã•ã‚ŒãŸã€‚`);
        
        if (p.role === 'ã¦ã‚‹ã¦ã‚‹') {
            alert(`ã€ã¦ã‚‹ã¦ã‚‹å‹åˆ©ã€‘${p.name}ãŒè¿½æ”¾ã•ã‚ŒãŸãŸã‚ã€ã¦ã‚‹ã¦ã‚‹åŠä¸»ã®å˜ç‹¬å‹åˆ©ã§ã™ï¼`);
            location.reload(); return;
        }
        if (!checkWin()) startNight();
    }

    function resolveNight() {
        const wolf = players.find(p => p.role === 'äººç‹¼' && p.isAlive);
        const knight = players.find(p => p.role === 'é¨å£«' && p.isAlive);
        let victims = [];

        // å æ®ºã®ç¢ºèª
        players.forEach(p => { if(!p.isAlive && p.killedBy === 'å æ®º') { victims.push(p.name); addLog(`ã€å‘ªæ®ºã€‘æ˜¨æ™©ã€${p.name}ã®å§¿ãŒæ¶ˆãˆã¦ã„ãŸã€‚`); } });

        // äººç‹¼ã®è¥²æ’ƒ
        if (wolf && wolf.target) {
            const target = players.find(p => p.name === wolf.target);
            if (target.role === 'ç‹') {
                addLog(`ã€è¥²æ’ƒã€‘å¹³å’Œãªå¤œã ã£ãŸï¼ˆç‹ã¯è¥²æ’ƒã§æ­»ãªãªã„ï¼‰ã€‚`);
            } else if (knight && knight.target === wolf.target) {
                addLog(`ã€å®ˆè­·ã€‘é¨å£«ãŒè¥²æ’ƒã‚’é˜»æ­¢ã—ãŸï¼`);
            } else {
                target.isAlive = false;
                addLog(`ã€è¥²æ’ƒã€‘æ˜¨æ™©ã€${target.name}ãŒç„¡æƒ¨ãªå§¿ã§è¦‹ã¤ã‹ã£ãŸã€‚`);
            }
        }
        players.forEach(p => p.target = null);
        if (!checkWin()) startTalk();
    }

    function checkWin() {
        const aliveWolves = players.filter(p => p.isAlive && p.role === 'äººç‹¼').length;
        const aliveHumans = players.filter(p => p.isAlive && p.role !== 'äººç‹¼' && p.role !== 'ç‹' && p.role !== 'ç‹‚äºº' && p.role !== 'ç‹‚ä¿¡è€…').length;
        const aliveFoxes = players.filter(p => p.isAlive && p.role === 'ç‹').length;

        if (aliveWolves === 0) {
            if (aliveFoxes > 0) { alert("äººç‹¼ã¯æ»…ã³ãŸãŒã€æ‘ã¯ç‹ã«æ†‘ã‚Šã¤ã‹ã‚ŒãŸâ€¦ã€ç‹ã®å˜ç‹¬å‹åˆ©ã€‘ï¼"); }
            else { alert("äººç‹¼ã¯æ»…ã³ãŸï¼ã€æ‘äººé™£å–¶ã®å‹åˆ©ã€‘ï¼"); }
            location.reload(); return true;
        }
        if (aliveWolves >= aliveHumans) {
            if (aliveFoxes > 0) { alert("æ‘ã¯æ”¯é…ã•ã‚ŒãŸãŒã€ç‹ãŒã™ã¹ã¦ã‚’å¥ªã£ãŸâ€¦ã€ç‹ã®å˜ç‹¬å‹åˆ©ã€‘ï¼"); }
            else { alert("æ‘ã¯ç‹¼ã«æ”¯é…ã•ã‚ŒãŸâ€¦ã€äººç‹¼é™£å–¶ã®å‹åˆ©ã€‘ï¼"); }
            location.reload(); return true;
        }
        return false;
    }

    function addLog(m) { 
        const l = document.getElementById('log'); 
        l.innerHTML = `<div style="border-bottom:1px solid #222; margin-bottom:5px;">${m}</div>` + l.innerHTML; 
    }

    initSetup();
</script>
</body>
</html>
